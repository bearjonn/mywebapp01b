<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxion 1979 ‚Äì niv√• 3 (JS + Canvas)</title>
  <style>
    html,body{height:100%;margin:0;background:#0b0f19;color:#e7eefc;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{display:grid;place-items:center;height:100%}
    canvas{background:#040710;border:2px solid #1e2b4a;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .hint{position:fixed;inset:auto 0 12px 0;text-align:center;opacity:.85;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="480" height="640"></canvas>
  </div>
  <div class="hint">Pil ‚Üê/‚Üí ‚Ä¢ SPACE skyter ‚Ä¢ R restart ‚Ä¢ 3 liv ‚Ä¢ Fiender skyter & dykker ‚Ä¢ Lyd: trykk en tast f√∏rst</div>

  <script>
  // --- Galaxian-inspirert, niv√• 3: fiendeskudd, liv, b√∏lger, DYKK-angrep, enkle partikler og lyd ---
  const W=480,H=640; const ctx=document.getElementById('game').getContext('2d');
  ctx.imageSmoothingEnabled=false;

  // Lyd (Web Audio) ‚Äì initialiseres ved f√∏rste tastepress
  let ac=null;
  function initAudio(){ if(!ac){ ac=new (window.AudioContext||window.webkitAudioContext)(); } }
  function beep(freq=440, dur=0.06, type='square', gain=0.04){
    if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ac.destination);
    const now=ac.currentTime; o.start(now); o.stop(now+dur);
  }

  // Spilltilstand
  let score=0, wave=1, lives=3; let gameOver=false, youWin=false;

  const player={ x:W/2, y:H-50, w:22, h:12, speed:4.0, cooldown:0, invuln:0 };
  const shots=[];         // spiller-skudd
  const enemyShots=[];    // fiende-skudd
  const particles=[];     // enkle partikler ved treff

  // Fiender
  let rows=5, cols=8; const enemies=[];
  const enemySpacingX=48, enemySpacingY=32;
  const enemyStartX=60, enemyStartY=80;
  let enemyDX=0.9, stepDown=18;
  let enemyFireTimer=1000;    // ms til neste fiendeskudd
  let enemyDiveTimer=2200;    // ms til neste dykker

  function colorForRow(r){ return r===0?'#ff5e5e':(r<3?'#ffd166':'#6ee7b7'); }

  function resetEnemies(){
    enemies.length=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        enemies.push({
          x: enemyStartX + c*enemySpacingX,
          y: enemyStartY + r*enemySpacingY,
          w:20,h:14, alive:true, row:r, col:c, color:colorForRow(r),
          mode:'formation', vx:0, vy:0
        });
      }
    }
  }

  function startWave(n){
    wave=n; enemyDX=0.9*Math.pow(1.08, wave-1); // raskere per b√∏lge
    stepDown=18; enemyFireTimer=Math.max(380, 1000-(wave-1)*70);
    enemyDiveTimer=Math.max(1200, 2400-(wave-1)*160); // hyppigere dykk
    resetEnemies();
  }

  startWave(1);

  // Input
  const keys={};
  addEventListener('keydown',e=>{ keys[e.code]=true; initAudio(); if(e.code==='KeyR') restart(); });
  addEventListener('keyup',e=>{ keys[e.code]=false; });

  function restart(){ score=0; lives=3; Object.assign(player,{x:W/2,y:H-50,cooldown:0,invuln:0});
    shots.length=0; enemyShots.length=0; particles.length=0; gameOver=false; youWin=false; startWave(1); }

  // Hjelp
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
  function rect(a,b){ return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h); }

  function firePlayer(){ if(player.cooldown>0) return; shots.push({x:player.x-2,y:player.y-10,w:4,h:10,vy:-6}); player.cooldown=165; beep(720,0.04,'square',0.035); }

  function fireEnemy(){
    const alive=enemies.filter(e=>e.alive);
    if(!alive.length) return;
    alive.sort((a,b)=>b.y-a.y);
    const choice=alive[Math.floor(Math.random()*Math.min(6,alive.length))];
    enemyShots.push({x:choice.x+choice.w/2-2, y:choice.y+choice.h, w:4,h:10, vy:3+0.15*wave});
    beep(240,0.06,'triangle',0.03);
  }

  function spawnParticles(x,y,color='#fff',count=12){
    for(let i=0;i<count;i++){
      const ang=Math.random()*Math.PI*2; const sp=1.5+Math.random()*2.5;
      particles.push({x,y, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:420, color});
    }
  }

  // Loop
  let last=performance.now();
  function loop(t){ const dt=t-last; last=t; update(dt); draw(); requestAnimationFrame(loop); }

  function update(dt){
    if(gameOver||youWin) return;

    // Spiller
    if(keys['ArrowLeft']||keys['KeyA']) player.x-=player.speed;
    if(keys['ArrowRight']||keys['KeyD']) player.x+=player.speed;
    player.x=clamp(player.x,16,W-16);
    if(keys['Space']) firePlayer();
    if(player.cooldown>0) player.cooldown-=dt; if(player.invuln>0) player.invuln-=dt;

    // Skudd
    for(let i=shots.length-1;i>=0;i--){ const s=shots[i]; s.y+=s.vy; if(s.y+s.h<0) shots.splice(i,1); }
    for(let i=enemyShots.length-1;i>=0;i--){ const s=enemyShots[i]; s.y+=s.vy; if(s.y>H) enemyShots.splice(i,1); }

    // Partikler
    for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.015; p.life-=dt; if(p.life<=0) particles.splice(i,1); }

    // Fiender
    let minX=Infinity,maxX=-Infinity, anyAlive=false;
    for(const e of enemies){
      if(!e.alive) continue; anyAlive=true;
      if(e.mode==='formation'){
        e.x+=enemyDX; minX=Math.min(minX,e.x); maxX=Math.max(maxX,e.x+e.w);
      } else if(e.mode==='dive'){
        // enkel styring mot spillerens x
        const steer=((player.x - e.x)*0.0025)*dt; e.vx=clamp(e.vx+steer,-2.2,2.2);
        e.vy=clamp(e.vy+0.0025*dt,2.2,5.2);
        e.x+=e.vx; e.y+=e.vy;
        // tilbake/ut
        if(e.y>H+40){ // kom seg forbi ‚Äì flytt tilbake til toppen som i ny formasjon
          e.y=enemyStartY-20; e.mode='formation'; e.vx=0; e.vy=0;
        }
      }
    }
    if(anyAlive && (minX<12||maxX>W-12)){
      enemyDX=-enemyDX; for(const e of enemies){ if(e.alive && e.mode==='formation') e.y+=stepDown; } enemyDX*=1.05;
    }

    // Kollisjoner: spiller-skudd treffer fiende
    for(let i=shots.length-1;i>=0;i--){ const s=shots[i]; let hit=false; for(const e of enemies){ if(!e.alive) continue; if(rect({x:s.x,y:s.y,w:s.w,h:s.h},e)){ e.alive=false; score+=10; spawnParticles(e.x+e.w/2,e.y+e.h/2,e.color,14); beep(560,0.05,'sawtooth',0.035); hit=true; break; } } if(hit) shots.splice(i,1); }

    // Fiende treffer spiller (skudd)
    if(player.invuln<=0){
      for(let i=enemyShots.length-1;i>=0;i--){ const s=enemyShots[i]; if(rect({x:s.x,y:s.y,w:s.w,h:s.h}, {x:player.x-12,y:player.y-10,w:24,h:18})){ enemyShots.splice(i,1); spawnParticles(player.x,player.y,'#8bffd1',18); loseLife(); break; } }
    }

    // Dykker treffer spiller
    if(player.invuln<=0){
      for(const e of enemies){ if(e.alive && rect({x:player.x-12,y:player.y-10,w:24,h:18}, e)){ spawnParticles(player.x,player.y,'#8bffd1',22); e.alive=false; loseLife(); break; } }
    }

    // Nederlag hvis fiende n√•r spilleren i formasjon
    for(const e of enemies){ if(e.alive && e.mode==='formation' && e.y+e.h>=player.y){ gameOver=true; }}

    // B√∏lge ferdig?
    if(enemies.every(e=>!e.alive)){
      if(wave>=6){ youWin=true; beep(880,0.18,'triangle',0.05); }
      else { nextWave(); }
    }

    // Tidsstyrte fiendehandlinger
    enemyFireTimer-=dt; if(enemyFireTimer<=0){ fireEnemy(); enemyFireTimer=Math.max(220, 900 - wave*80); }
    enemyDiveTimer-=dt; if(enemyDiveTimer<=0){ launchDiver(); enemyDiveTimer=Math.max(800, 2200 - wave*140); }
  }

  function launchDiver(){
    const candidates=enemies.filter(e=>e.alive && e.mode==='formation');
    if(!candidates.length) return;
    // Velg en i de √∏verste radene for variasjon
    candidates.sort((a,b)=>a.row-b.row || Math.random()-0.5);
    const e=candidates[0]; e.mode='dive'; e.vx=(Math.random()<0.5?-1:1)*1.2; e.vy=2.2;
    // Liten lydsignal
    beep(300,0.08,'sine',0.04);
  }

  function loseLife(){
    lives--; beep(220,0.08,'square',0.06);
    if(lives<=0){ gameOver=true; return; }
    player.x=W/2; player.invuln=1500;
  }

  function nextWave(){
    shots.length=0; enemyShots.length=0; particles.length=0; startWave(wave+1); beep(660,0.1,'triangle',0.04);
  }

  // Tegning
  function draw(){
    // Bakgrunn
    ctx.fillStyle='#050814'; ctx.fillRect(0,0,W,H);
    for(let i=0;i<64;i++){ const x=(i*73%W); const y=(i*131%H); ctx.fillStyle=i%7===0?'#7dd3fc':'#93c5fd'; ctx.fillRect((x+performance.now()/70)%W,y,2,2); }

    // UI
    ctx.fillStyle='#e7eefc'; ctx.font='16px system-ui, sans-serif';
    ctx.fillText('SCORE: '+score,16,24); ctx.fillText('WAVE: '+wave, W/2-28,24); ctx.fillText('LIV: '+lives, W-90,24);

    // Spiller
    drawPlayer(player.x, player.y, player.invuln>0);

    // Skudd
    ctx.fillStyle='#a5b4fc'; for(const s of shots){ ctx.fillRect(s.x,s.y,s.w,s.h); }
    ctx.fillStyle='#fca5a5'; for(const s of enemyShots){ ctx.fillRect(s.x,s.y,s.w,s.h); }

    // Fiender
    for(const e of enemies){ if(!e.alive) continue; drawEnemy(e); }

    // Partikler
    for(const p of particles){ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,2,2); }

    if(gameOver||youWin){ ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,W,H); ctx.fillStyle=youWin?'#7ef29a':'#ff8fa3'; ctx.font='bold 28px system-ui, sans-serif'; ctx.textAlign='center'; ctx.fillText(youWin?'SEIER! üéâ':'GAME OVER',W/2,H/2-12); ctx.font='16px system-ui, sans-serif'; ctx.fillStyle='#e7eefc'; ctx.fillText('Trykk R for √• restarte', W/2, H/2+16); ctx.textAlign='start'; }
  }

  function drawPlayer(px,py,blink){
    if(blink && Math.floor(performance.now()/120)%2===0) return; // enkel blink ved invuln
    ctx.fillStyle='#8bffd1'; ctx.beginPath(); ctx.moveTo(px,py-10); ctx.lineTo(px-12,py+8); ctx.lineTo(px+12,py+8); ctx.closePath(); ctx.fill();
  }

  function drawEnemy(e){
    // formasjon vs dykker ‚Äì gi en enkel nese dersom dykker
    ctx.fillStyle=e.color; ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.fillStyle='#0b0f19'; ctx.fillRect(e.x+4,e.y+4,4,4); ctx.fillRect(e.x+e.w-8,e.y+4,4,4);
    if(e.mode==='dive'){
      ctx.fillStyle=e.color; ctx.fillRect(e.x+e.w/2-2, e.y+e.h, 4, 6);
    }
  }

  requestAnimationFrame(loop);
  </script>
</body>
</html>